{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.10.15", "generated_at": "2026-01-10T21:41:09.358389Z", "invocation_id": "f6ef9c90-05a8-4c46-a74d-8c18d178e368", "invocation_started_at": "2026-01-10T21:41:05.086127Z", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2026-01-10T21:41:07.951204Z", "completed_at": "2026-01-10T21:41:08.039763Z"}, {"name": "execute", "started_at": "2026-01-10T21:41:08.046088Z", "completed_at": "2026-01-10T21:41:08.502474Z"}], "thread_id": "Thread-4 (worker)", "execution_time": 0.5774376392364502, "adapter_response": {"_message": "SELECT 100", "code": "SELECT", "rows_affected": 100}, "message": "SELECT 100", "failures": null, "unique_id": "model.across_analytics.mart_route_concentration_risk", "compiled": true, "compiled_code": "-- mart_route_concentration_risk.sql\n-- PURPOSE: Analyze relayer concentration risk per route using CR3 (Share of Top 3 Relayers)\n-- METRICS: Filler Dominance Index, Total Volume, Top 3 Volume\n\n\n\nWITH relayer_volume_by_route AS (\n    -- Step 1: Sum volume per relayer per route\n    SELECT \n        origin_chain_name,\n        destination_chain_name,\n        route_name,\n        relayer_address,\n        SUM(fill_amount_usd) AS relayer_volume_usd\n    FROM \"across_analytics\".\"dbt_intermediate\".\"int_deposit_fill_matching\"\n    WHERE is_filled = TRUE \n      AND relayer_address IS NOT NULL\n      AND route_name IS NOT NULL\n      AND fill_amount_usd > 0  -- Exclude zero/null amounts\n    GROUP BY origin_chain_name, destination_chain_name, route_name, relayer_address\n),\n\nranked_relayers AS (\n    -- Step 2: Rank relayers within each route by volume\n    SELECT \n        origin_chain_name,\n        destination_chain_name,\n        route_name,\n        relayer_address,\n        relayer_volume_usd,\n        ROW_NUMBER() OVER (\n            PARTITION BY route_name \n            ORDER BY relayer_volume_usd DESC\n        ) AS rank_in_route\n    FROM relayer_volume_by_route\n),\n\nroute_totals AS (\n    -- Step 3: Calculate total volume per route\n    SELECT \n        route_name,\n        SUM(relayer_volume_usd) AS total_route_volume_usd\n    FROM relayer_volume_by_route\n    GROUP BY route_name\n    HAVING SUM(relayer_volume_usd) > 0  -- Only routes with positive volume\n),\n\ntop3_volume AS (\n    -- Step 4: Sum volume of top 3 relayers per route\n    SELECT \n        origin_chain_name,\n        destination_chain_name,\n        route_name,\n        SUM(relayer_volume_usd) AS top3_volume_usd\n    FROM ranked_relayers\n    WHERE rank_in_route <= 3\n    GROUP BY origin_chain_name, destination_chain_name, route_name\n)\n\n-- Step 5: Calculate Filler Dominance Index per Route\nSELECT \n    t.origin_chain_name,\n    t.destination_chain_name,\n    t.route_name,\n    ROUND(rt.total_route_volume_usd::NUMERIC, 2) AS total_volume_usd,\n    ROUND(t.top3_volume_usd::NUMERIC, 2) AS top_3_relayer_volume_usd,\n    ROUND((t.top3_volume_usd / NULLIF(rt.total_route_volume_usd, 0) * 100)::NUMERIC, 2) \n        AS filler_dominance_index_pct,\n    -- Risk classification\n    CASE \n        WHEN rt.total_route_volume_usd = 0 OR rt.total_route_volume_usd IS NULL THEN 'NO DATA'\n        WHEN (t.top3_volume_usd / rt.total_route_volume_usd * 100) > 90 THEN 'CRITICAL'\n        WHEN (t.top3_volume_usd / rt.total_route_volume_usd * 100) > 80 THEN 'HIGH'\n        WHEN (t.top3_volume_usd / rt.total_route_volume_usd * 100) > 60 THEN 'MODERATE'\n        ELSE 'HEALTHY'\n    END AS concentration_risk\nFROM top3_volume t\nJOIN route_totals rt ON t.route_name = rt.route_name\nORDER BY filler_dominance_index_pct DESC", "relation_name": "\"across_analytics\".\"dbt_marts\".\"mart_route_concentration_risk\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2026-01-10T21:41:07.938320Z", "completed_at": "2026-01-10T21:41:08.038627Z"}, {"name": "execute", "started_at": "2026-01-10T21:41:08.040918Z", "completed_at": "2026-01-10T21:41:08.872617Z"}], "thread_id": "Thread-3 (worker)", "execution_time": 0.9560971260070801, "adapter_response": {"_message": "SELECT 15063", "code": "SELECT", "rows_affected": 15063}, "message": "SELECT 15063", "failures": null, "unique_id": "model.across_analytics.mart_general_overview", "compiled": true, "compiled_code": "-- mart_general_overview.sql\n-- PURPOSE: High-level protocol overview for the main Superset dashboard\n-- GRAIN: Minute \u00d7 Origin Chain \u00d7 Destination Chain \u00d7 Token\n-- WHY: Provides general metrics with drill-down capability for flexible Superset filtering\n\n\n\nWITH base_data AS (\n    SELECT\n        *,\n        DATE_TRUNC('minute', deposit_timestamp) AS deposit_minute\n    FROM \"across_analytics\".\"dbt_intermediate\".\"int_deposit_fill_matching\"\n),\n\n-- Chain name mapping\nchain_names AS (\n    SELECT \n        chain_id,\n        chain_name\n    FROM (VALUES\n        (1, 'Ethereum'),\n        (42161, 'Arbitrum'),\n        (137, 'Polygon'),\n        (59144, 'Linea'),\n        (480, 'Worldchain'),\n        (130, 'Unichain'),\n        (999, 'HyperEVM'),\n        (143, 'Monad')\n    ) AS chains(chain_id, chain_name)\n),\n\n-- Token metadata for symbol lookup\ntoken_metadata AS (\n    SELECT * FROM \"across_analytics\".\"dbt\".\"token_metadata\"\n),\n\n-- Aggregate by hour, route, and token\nhourly_metrics AS (\n    SELECT\n        deposit_minute,\n        origin_chain_id,\n        destination_chain_id,\n        route_id,\n        deposit_token,\n        \n        -- === VOLUME METRICS ===\n        -- Transaction counts\n        COUNT(*) AS total_deposits,\n        SUM(CASE WHEN is_filled THEN 1 ELSE 0 END) AS total_fills,\n        \n        -- Volume in native token units\n        SUM(deposit_amount) AS total_deposit_volume,\n        SUM(CASE WHEN is_filled THEN actual_output_amount ELSE 0 END) AS total_filled_volume,\n        \n        -- Volume in USD\n        SUM(deposit_amount_usd) AS total_deposit_volume_usd,\n        SUM(CASE WHEN is_filled THEN fill_amount_usd ELSE 0 END) AS total_filled_volume_usd,\n        \n        -- === ACTIVITY METRICS ===\n        COUNT(DISTINCT depositor_address) AS unique_depositors,\n        COUNT(DISTINCT relayer_address) FILTER (WHERE is_filled) AS unique_relayers,\n        \n        -- === PERFORMANCE SNAPSHOT (summary only) ===\n        -- Fill rate\n        ROUND((SUM(CASE WHEN is_filled THEN 1 ELSE 0 END)::NUMERIC / NULLIF(COUNT(*), 0)) * 100, 2) AS fill_rate_pct,\n        \n        -- Latency summary (just avg and median for overview)\n        ROUND(AVG(CASE WHEN is_filled THEN fill_latency_seconds END)::NUMERIC, 2) AS avg_fill_latency_seconds,\n        ROUND(PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY fill_latency_seconds) FILTER (WHERE is_filled)::NUMERIC, 2) AS median_fill_latency_seconds,\n        \n        -- === ECONOMIC SNAPSHOT (summary only) ===\n        -- Total fees collected\n        SUM(CASE WHEN is_filled THEN bridge_fee_nominal ELSE 0 END) AS total_bridge_fees,\n        \n        -- Average fee percentage\n        ROUND(AVG(CASE WHEN is_filled THEN bridge_fee_percent END)::NUMERIC, 4) AS avg_bridge_fee_pct,\n        \n        -- Average slippage\n        ROUND(AVG(CASE WHEN is_filled THEN slippage_percent END)::NUMERIC, 4) AS avg_slippage_pct\n        \n    FROM base_data\n    GROUP BY \n        deposit_minute,\n        origin_chain_id,\n        destination_chain_id,\n        route_id,\n        deposit_token\n)\n\nSELECT\n    -- Time dimension\n    hm.deposit_minute,\n    \n    -- Route identifiers with human-readable names\n    hm.origin_chain_id,\n    oc.chain_name AS origin_chain_name,\n    hm.destination_chain_id,\n    dc.chain_name AS destination_chain_name,\n    hm.route_id,\n    oc.chain_name || ' \u2192 ' || dc.chain_name AS route_name,\n    \n    -- Token info\n    hm.deposit_token,\n    tm.token_symbol,\n    -- handle token symbol for base token as USDC.e and USDC.bridged are the same, etc.\n    CASE \n        WHEN token_symbol LIKE 'USDC%' THEN 'USDC'\n        WHEN token_symbol LIKE 'USDT%' THEN 'USDT'\n        WHEN token_symbol LIKE 'DAI%' THEN 'DAI'\n        WHEN token_symbol LIKE 'WETH%' THEN 'WETH'\n        WHEN token_symbol LIKE 'WBTC%' THEN 'WBTC'\n    ELSE token_symbol\n    END AS base_token_symbol,\n    \n    -- Volume metrics\n    hm.total_deposits,\n    hm.total_fills,\n    hm.total_deposit_volume,\n    hm.total_filled_volume,\n    hm.total_deposit_volume_usd,\n    hm.total_filled_volume_usd,\n    \n    -- Activity metrics\n    hm.unique_depositors,\n    hm.unique_relayers,\n    \n    -- Performance snapshot\n    hm.fill_rate_pct,\n    hm.avg_fill_latency_seconds,\n    hm.median_fill_latency_seconds,\n    \n    -- Economic snapshot\n    hm.total_bridge_fees,\n    hm.avg_bridge_fee_pct,\n    hm.avg_slippage_pct\n\nFROM hourly_metrics hm\nLEFT JOIN chain_names oc ON hm.origin_chain_id = oc.chain_id\nLEFT JOIN chain_names dc ON hm.destination_chain_id = dc.chain_id\nLEFT JOIN token_metadata tm ON hm.origin_chain_id = tm.chain_id \n    AND LOWER(hm.deposit_token) = LOWER(tm.token_address)\n\nORDER BY hm.deposit_minute DESC, hm.total_deposit_volume_usd DESC", "relation_name": "\"across_analytics\".\"dbt_marts\".\"mart_general_overview\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2026-01-10T21:41:07.928477Z", "completed_at": "2026-01-10T21:41:07.996200Z"}, {"name": "execute", "started_at": "2026-01-10T21:41:08.033168Z", "completed_at": "2026-01-10T21:41:08.934538Z"}], "thread_id": "Thread-2 (worker)", "execution_time": 1.049640417098999, "adapter_response": {"_message": "SELECT 15063", "code": "SELECT", "rows_affected": 15063}, "message": "SELECT 15063", "failures": null, "unique_id": "model.across_analytics.mart_fill_latency_analysis", "compiled": true, "compiled_code": "-- ============================================================================\n-- mart_fill_latency_analysis.sql\n-- ============================================================================\n-- PURPOSE: Analyze Time-to-Fill (TTF) to identify filler hesitation and \n--          liquidity gaps across routes\n-- \n-- GRAIN: Minute \u00d7 Route \u00d7 Token\n-- \n-- KEY BUSINESS QUESTIONS:\n--   1. Which routes have \"Filler Hesitation\"? \u2192 slow_fill_pct > 10%\n--   2. Is a new chain's filler infrastructure mature? \u2192 Compare p95_ttf\n--   3. Where should we prioritize filler incentives? \u2192 liquidity_gap_status = 'HIGH'\n-- ============================================================================\n\n\n\nWITH base_data AS (\n    SELECT\n        *,\n        DATE_TRUNC('minute', deposit_timestamp) AS deposit_minute\n    FROM \"across_analytics\".\"dbt_intermediate\".\"int_deposit_fill_matching\"\n),\n\n-- Chain name mapping\nchain_names AS (\n    SELECT \n        chain_id,\n        chain_name\n    FROM (VALUES\n        (1, 'Ethereum'),\n        (42161, 'Arbitrum'),\n        (137, 'Polygon'),\n        (59144, 'Linea'),\n        (480, 'Worldchain'),\n        (130, 'Unichain'),\n        (999, 'HyperEVM'),\n        (143, 'Monad')\n    ) AS chains(chain_id, chain_name)\n),\n\n-- Token metadata for symbol lookup\ntoken_metadata AS (\n    SELECT * FROM \"across_analytics\".\"dbt\".\"token_metadata\"\n),\n\n-- Aggregate by hour, route, and token\nhourly_latency_metrics AS (\n    SELECT\n        deposit_minute,\n        origin_chain_id,\n        destination_chain_id,\n        route_id,\n        deposit_token,\n        \n        -- === VOLUME METRICS ===\n        COUNT(*) AS total_deposits,\n        SUM(CASE WHEN is_filled THEN 1 ELSE 0 END) AS total_fills,\n        SUM(CASE WHEN NOT is_filled THEN 1 ELSE 0 END) AS unfilled_count,\n        \n        -- Fill rate\n        ROUND(\n            (SUM(CASE WHEN is_filled THEN 1 ELSE 0 END)::NUMERIC / NULLIF(COUNT(*), 0)) * 100, \n            2\n        ) AS fill_rate_pct,\n        \n        -- === LATENCY DISTRIBUTION ===\n        -- Core TTF metrics (only for filled deposits)\n        ROUND(AVG(CASE WHEN is_filled THEN fill_latency_seconds END)::NUMERIC, 2) AS avg_ttf_seconds,\n        ROUND(\n            PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY fill_latency_seconds) \n            FILTER (WHERE is_filled)::NUMERIC, \n            2\n        ) AS median_ttf_seconds,\n        ROUND(\n            PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY fill_latency_seconds) \n            FILTER (WHERE is_filled)::NUMERIC, \n            2\n        ) AS p95_ttf_seconds,\n        MIN(CASE WHEN is_filled THEN fill_latency_seconds END) AS min_ttf_seconds,\n        MAX(CASE WHEN is_filled THEN fill_latency_seconds END) AS max_ttf_seconds,\n        \n        -- === SPEED BUCKET COUNTS ===\n        -- Instant fills (\u226430 seconds) - \"Lightning fast\"\n        SUM(CASE WHEN is_filled AND fill_latency_seconds <= 30 THEN 1 ELSE 0 END) AS instant_fill_count,\n        \n        -- Fast fills (\u226460 seconds)\n        SUM(CASE WHEN is_filled AND fill_latency_seconds <= 60 THEN 1 ELSE 0 END) AS fast_fill_count,\n        \n        -- Slow fills (>300 seconds / 5 minutes) - \"Filler Hesitation\"\n        SUM(CASE WHEN is_filled AND fill_latency_seconds > 300 THEN 1 ELSE 0 END) AS slow_fill_count,\n        \n        -- Very slow fills (>900 seconds / 15 minutes) - \"Critical Delay\"\n        SUM(CASE WHEN is_filled AND fill_latency_seconds > 900 THEN 1 ELSE 0 END) AS very_slow_fill_count,\n        \n        -- === VOLUME CONTEXT ===\n        SUM(deposit_amount_usd) AS total_deposit_volume_usd,\n        SUM(CASE WHEN is_filled THEN fill_amount_usd ELSE 0 END) AS total_filled_volume_usd,\n        \n        -- === PARTICIPANT METRICS ===\n        COUNT(DISTINCT relayer_address) FILTER (WHERE is_filled) AS unique_relayers\n        \n    FROM base_data\n    GROUP BY \n        deposit_minute,\n        origin_chain_id,\n        destination_chain_id,\n        route_id,\n        deposit_token\n),\n\n-- ============================================================================\n-- COMPUTED INSIGHTS CTE\n-- ============================================================================\n-- PURPOSE: Transform raw counts into actionable percentages and categorical \n--          labels that can be used directly in Superset filters and alerts.\n-- ============================================================================\nwith_insights AS (\n    SELECT\n        *,\n        \n        -- ========================================================================\n        -- INSTANT FILL PERCENTAGE\n        -- ========================================================================\n        -- WHAT: % of fills completed in \u226430 seconds\n        -- WHY:  Measures \"lightning fast\" user experience. High % = excellent UX.\n        --       Across's competitive advantage is speed - this proves it.\n        -- USE:  Dashboard KPI, compare across routes to find speed champions.\n        -- ========================================================================\n        ROUND(\n            (instant_fill_count::NUMERIC / NULLIF(total_fills, 0)) * 100, \n            2\n        ) AS instant_fill_pct,\n        \n        -- ========================================================================\n        -- FAST FILL PERCENTAGE\n        -- ========================================================================\n        -- WHAT: % of fills completed in \u226460 seconds (includes instant fills)\n        -- WHY:  Broader \"good experience\" threshold. Users generally don't \n        --       notice delays under 1 minute. Target: >90% for healthy routes.\n        -- USE:  Route health monitoring, alerting if drops below threshold.\n        -- ========================================================================\n        ROUND(\n            (fast_fill_count::NUMERIC / NULLIF(total_fills, 0)) * 100, \n            2\n        ) AS fast_fill_pct,\n        \n        -- ========================================================================\n        -- SLOW FILL PERCENTAGE (\"Filler Hesitation\" Indicator)\n        -- ========================================================================\n        -- WHAT: % of fills taking >5 minutes (300 seconds)\n        -- WHY:  5+ minute waits indicate fillers are HESITATING to fill this route.\n        --       Causes: low liquidity, high risk perception, poor RPC, or \n        --       unfavorable economics on that destination chain.\n        -- USE:  Alert trigger (>10% = investigate), filler incentive prioritization.\n        -- ========================================================================\n        ROUND(\n            (slow_fill_count::NUMERIC / NULLIF(total_fills, 0)) * 100, \n            2\n        ) AS slow_fill_pct,\n        \n        -- ========================================================================\n        -- VERY SLOW FILL PERCENTAGE (\"Critical Delay\" Indicator)\n        -- ========================================================================\n        -- WHAT: % of fills taking >15 minutes (900 seconds)\n        -- WHY:  15+ minute waits are CRITICAL failures. Users likely abandoned\n        --       or contacted support. These routes need immediate attention.\n        -- USE:  High-priority alert, escalation to engineering team.\n        -- ========================================================================\n        ROUND(\n            (very_slow_fill_count::NUMERIC / NULLIF(total_fills, 0)) * 100, \n            2\n        ) AS very_slow_fill_pct,\n        \n        -- ========================================================================\n        -- LIQUIDITY GAP STATUS (Categorical Health Label)\n        -- ========================================================================\n        -- WHAT: Classifies each hourly observation as CRITICAL / HIGH / MODERATE / HEALTHY \n        --       based on the p95 TTF for that hour-route-token combination.\n        -- WHY:  Provides a simple filter in Superset: \"Show me all CRITICAL gap routes\"\n        --       The p95 is used (not avg) because we care about WORST-CASE experience.\n        -- \n        -- DATA-DRIVEN THRESHOLDS (based on actual distribution from dataset):\n        --   Raw fill latencies (all users): median=8s, p75=15s, p95=42s\n        --   Route-level p95s: median=10.5s, p75=24s, p95=96s\n        --\n        --   - CRITICAL: > 100s  \u2192 Route's worst 5% is 2.5x slower than global worst 5%\n        --   - HIGH:     30-100s \u2192 Route's worst 5% exceeds global p95 (42s), investigate\n        --   - MODERATE: 15-30s  \u2192 Route's worst 5% is typical to slightly slow\n        --   - HEALTHY:  < 15s   \u2192 Route's worst 5% beats global p75 (15s), excellent UX\n        --\n        -- USE:  Superset filter, executive summary, filler incentive targeting.\n        -- ========================================================================\n        CASE \n            WHEN p95_ttf_seconds > 100 THEN 'CRITICAL'\n            WHEN p95_ttf_seconds > 30 THEN 'HIGH'\n            WHEN p95_ttf_seconds > 15 THEN 'MODERATE'\n            ELSE 'HEALTHY'\n        END AS liquidity_gap_status\n        \n    FROM hourly_latency_metrics\n)\n\nSELECT\n    -- Time dimension\n    wi.deposit_minute,\n    \n    -- Route identifiers with human-readable names\n    wi.origin_chain_id,\n    oc.chain_name AS origin_chain_name,\n    wi.destination_chain_id,\n    dc.chain_name AS destination_chain_name,\n    wi.route_id,\n    oc.chain_name || ' \u2192 ' || dc.chain_name AS route_name,\n    \n    -- Token info\n    wi.deposit_token,\n    tm.token_symbol,\n    CASE \n        WHEN tm.token_symbol LIKE 'USDC%' THEN 'USDC'\n        WHEN tm.token_symbol LIKE 'USDT%' THEN 'USDT'\n        WHEN tm.token_symbol LIKE 'DAI%' THEN 'DAI'\n        WHEN tm.token_symbol LIKE 'WETH%' THEN 'WETH'\n        WHEN tm.token_symbol LIKE 'WBTC%' THEN 'WBTC'\n        ELSE tm.token_symbol\n    END AS base_token_symbol,\n    \n    -- Volume metrics\n    wi.total_deposits,\n    wi.total_fills,\n    wi.unfilled_count,\n    wi.fill_rate_pct,\n    wi.total_deposit_volume_usd,\n    wi.total_filled_volume_usd,\n    \n    -- Latency distribution\n    wi.avg_ttf_seconds,\n    wi.median_ttf_seconds,\n    wi.p95_ttf_seconds,\n    wi.min_ttf_seconds,\n    wi.max_ttf_seconds,\n    \n    -- Speed bucket counts\n    wi.instant_fill_count,\n    wi.fast_fill_count,\n    wi.slow_fill_count,\n    wi.very_slow_fill_count,\n    \n    -- Speed bucket percentages\n    wi.instant_fill_pct,\n    wi.fast_fill_pct,\n    wi.slow_fill_pct,\n    wi.very_slow_fill_pct,\n    \n    -- Computed insights\n    wi.liquidity_gap_status,\n    \n    -- Participant metrics\n    wi.unique_relayers\n\nFROM with_insights wi\nLEFT JOIN chain_names oc ON wi.origin_chain_id = oc.chain_id\nLEFT JOIN chain_names dc ON wi.destination_chain_id = dc.chain_id\nLEFT JOIN token_metadata tm ON wi.origin_chain_id = tm.chain_id \n    AND LOWER(wi.deposit_token) = LOWER(tm.token_address)\n\nORDER BY wi.deposit_minute DESC, wi.total_deposit_volume_usd DESC", "relation_name": "\"across_analytics\".\"dbt_marts\".\"mart_fill_latency_analysis\"", "batch_results": null}, {"status": "success", "timing": [{"name": "compile", "started_at": "2026-01-10T21:41:07.887690Z", "completed_at": "2026-01-10T21:41:07.949710Z"}, {"name": "execute", "started_at": "2026-01-10T21:41:07.960734Z", "completed_at": "2026-01-10T21:41:09.205562Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 1.3269054889678955, "adapter_response": {"_message": "SELECT 14513", "code": "SELECT", "rows_affected": 14513}, "message": "SELECT 14513", "failures": null, "unique_id": "model.across_analytics.mart_bridge_fee_analysis", "compiled": true, "compiled_code": "-- ============================================================================\n-- mart_bridge_fee_analysis.sql\n-- ============================================================================\n-- PURPOSE: Analyze bridge fees to identify over-priced corridors and \n--          inform competitive pricing strategy\n-- \n-- GRAIN: Minute \u00d7 Route \u00d7 Token\n-- \n-- KEY INSIGHT: bridge_fee_nominal = deposit_amount - actual_output_amount\n--              This already includes ALL user costs: gas + relayer + bridge + slippage\n-- \n-- KEY BUSINESS QUESTIONS:\n--   1. Which corridors are overpriced? \u2192 effective_fee_pct comparison\n--   2. ETH\u2192Unichain vs ETH\u2192Optimism fee comparison \u2192 Filter by origin, group by destination\n--   3. Where are users paying the most? \u2192 Sort by effective_fee_pct DESC\n-- ============================================================================\n\n\n\nWITH base_data AS (\n    SELECT\n        *,\n        DATE_TRUNC('minute', deposit_timestamp) AS deposit_minute\n    FROM \"across_analytics\".\"dbt_intermediate\".\"int_deposit_fill_matching\"\n    WHERE is_filled = TRUE  -- Only filled deposits have fee data\n),\n\n-- Chain name mapping\nchain_names AS (\n    SELECT \n        chain_id,\n        chain_name\n    FROM (VALUES\n        (1, 'Ethereum'),\n        (42161, 'Arbitrum'),\n        (137, 'Polygon'),\n        (59144, 'Linea'),\n        (480, 'Worldchain'),\n        (130, 'Unichain'),\n        (999, 'HyperEVM'),\n        (143, 'Monad')\n    ) AS chains(chain_id, chain_name)\n),\n\n-- Token metadata for symbol lookup\ntoken_metadata AS (\n    SELECT * FROM \"across_analytics\".\"dbt\".\"token_metadata\"\n),\n\n-- ============================================================================\n-- HOURLY FEE METRICS CTE\n-- ============================================================================\n-- PURPOSE: Aggregate fee-related metrics by hour, route, and token.\n--          All fee calculations are in USD for cross-token comparability.\n-- ============================================================================\nhourly_fee_metrics AS (\n    SELECT\n        deposit_minute,\n        origin_chain_id,\n        destination_chain_id,\n        route_id,\n        deposit_token,\n        \n        -- ========================================================================\n        -- VOLUME METRICS\n        -- ========================================================================\n        -- WHAT: Count of filled transactions and USD volume\n        -- WHY:  Provides context for fee metrics. A route with $10M volume and\n        --       0.3% fee is more important than $10K volume with 0.1% fee.\n        -- USE:  Weight fee analysis by volume, filter out low-activity routes.\n        -- ========================================================================\n        COUNT(*) AS total_fills,\n        SUM(deposit_amount_usd) AS total_deposit_volume_usd,\n        SUM(fill_amount_usd) AS total_filled_volume_usd,\n        \n        -- ========================================================================\n        -- TOTAL FEES (USD)\n        -- ========================================================================\n        -- WHAT: Sum of all fees collected on this route, converted to USD\n        -- WHY:  bridge_fee_nominal = deposit_amount - actual_output_amount\n        --       This is the ALL-IN user cost including gas, relayer, and protocol fees.\n        -- USE:  Revenue analysis, compare fee revenue across routes.\n        -- ========================================================================\n        SUM(bridge_fee_nominal * COALESCE(deposit_token_price_usd, 1)) AS total_fees_usd,\n        \n        -- ========================================================================\n        -- EFFECTIVE FEE PERCENTAGE (Core Metric)\n        -- ========================================================================\n        -- WHAT: Total fees / Total volume \u00d7 100 (volume-weighted average fee)\n        -- WHY:  This is the TRUE cost per dollar bridged. Unlike avg_fee_pct,\n        --       this weights large transactions more heavily (as they should be).\n        --       Example: 10 small txns at 0.5% + 1 large txn at 0.1% \u2192 effective < 0.5%\n        -- USE:  Primary metric for corridor pricing comparison. Target: <0.3%.\n        -- ========================================================================\n        ROUND(\n            ((SUM(bridge_fee_nominal * COALESCE(deposit_token_price_usd, 1)) / \n             NULLIF(SUM(deposit_amount_usd), 0)) * 100)::NUMERIC, 4) \n        AS effective_fee_pct,\n        \n        -- ========================================================================\n        -- AVERAGE FEE PERCENTAGE\n        -- ========================================================================\n        -- WHAT: Simple arithmetic mean of fee % across all transactions\n        -- WHY:  Treats all transactions equally. Useful for understanding \"typical\"\n        --       user experience regardless of transaction size.\n        -- USE:  Compare with effective_fee_pct; big difference = size disparity.\n        -- ========================================================================\n        ROUND(AVG(bridge_fee_percent)::NUMERIC, 4) AS avg_fee_pct,\n        \n        -- ========================================================================\n        -- MEDIAN FEE PERCENTAGE\n        -- ========================================================================\n        -- WHAT: 50th percentile of fee % (half of txns pay more, half pay less)\n        -- WHY:  More robust than avg to outliers. If median << avg, there are\n        --       some transactions with unusually high fees (investigate why).\n        -- USE:  Robust \"typical\" fee, outlier detection when compared to avg.\n        -- ========================================================================\n        ROUND(\n            PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY bridge_fee_percent)::NUMERIC, \n            4\n        ) AS median_fee_pct,\n        \n        -- ========================================================================\n        -- FEE STANDARD DEVIATION\n        -- ========================================================================\n        -- WHAT: How much fee % varies across transactions\n        -- WHY:  High std dev = unpredictable pricing for users. Users prefer\n        --       consistent fees. High volatility may indicate dynamic pricing\n        --       issues or liquidity fluctuations.\n        -- USE:  Stability indicator, alerting on high volatility routes.\n        -- ========================================================================\n        ROUND(STDDEV(bridge_fee_percent)::NUMERIC, 4) AS fee_std_dev,\n        \n        -- ========================================================================\n        -- MIN/MAX FEE PERCENTAGE\n        -- ========================================================================\n        -- WHAT: Best and worst fee % observed on this route\n        -- WHY:  Shows the full range of user experience. Large spread indicates\n        --       inconsistent pricing that confuses users.\n        -- USE:  Outlier investigation, competitive analysis (\"best rate we offer\").\n        -- ========================================================================\n        ROUND(MIN(bridge_fee_percent)::NUMERIC, 4) AS min_fee_pct,\n        ROUND(MAX(bridge_fee_percent)::NUMERIC, 4) AS max_fee_pct,\n        \n        -- ========================================================================\n        -- SLIPPAGE METRICS (Transparency, Not Cost)\n        -- ========================================================================\n        -- WHAT: Difference between expected_output and actual_output as %\n        -- WHY:  Slippage is ALREADY INCLUDED in bridge_fee_nominal. We show it\n        --       separately for transparency: how much of the fee is \"predictable\"\n        --       vs \"market movement\".\n        -- NOTE: Positive slippage = user got less than expected (bad)\n        --       Negative slippage = user got more than expected (rare, good)\n        -- USE:  Transparency reporting, not for cost calculation.\n        -- ========================================================================\n        ROUND(AVG(slippage_percent)::NUMERIC, 4) AS avg_slippage_pct,\n        ROUND(\n            PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY slippage_percent)::NUMERIC, \n            4\n        ) AS median_slippage_pct,\n        \n        -- ========================================================================\n        -- PARTICIPANT METRICS\n        -- ========================================================================\n        -- WHAT: Count of unique users and relayers on this route\n        -- WHY:  High depositor count = popular route (user demand).\n        --       High relayer count = competitive filling (healthy supply).\n        --       Low relayer count + high volume = relayer concentration risk.\n        -- USE:  Market health assessment, relayer diversity monitoring.\n        -- ========================================================================\n        COUNT(DISTINCT depositor_address) AS unique_depositors,\n        COUNT(DISTINCT relayer_address) AS unique_relayers,\n        \n        -- ========================================================================\n        -- GAS COST METRICS (Relayer Cost Analysis)\n        -- ========================================================================\n        -- WHAT: Gas price and cost metrics for relayer fills\n        -- WHY:  Gas costs are incurred by RELAYERS on the destination chain.\n        --       High gas costs may:\n        --       - Reduce relayer profitability \u2192 fewer fillers \u2192 slower fills\n        --       - Force higher bridge fees to remain profitable\n        --       - Explain fee volatility on certain corridors\n        -- USE:  Relayer economics analysis, corridor cost comparison, fee justification.\n        -- ========================================================================\n        -- ========================================================================\n        -- Average gas price in Gwei (wei / 10^9)\n        -- NOTE: Cast to NUMERIC before aggregation to prevent bigint overflow\n        ROUND((AVG(gas_price_wei::NUMERIC) / 1e9)::NUMERIC, 4) AS avg_gas_price_gwei,\n        \n        -- Median gas price in Gwei (more robust than average)\n        ROUND(\n            (PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY gas_price_wei::NUMERIC) / 1e9)::NUMERIC, \n            4\n        ) AS median_gas_price_gwei,\n        \n        -- Total gas cost in native token (sum of all relayer gas costs)\n        -- NOTE: Different chains use different native tokens (ETH, MATIC, WLD, etc.)\n        -- NOTE: Cast to NUMERIC before aggregation to prevent bigint overflow\n        ROUND((SUM(gas_cost_wei::NUMERIC) / 1e18)::NUMERIC, 8) AS total_gas_cost_native,\n        \n        -- Average gas cost per fill in native token\n        ROUND((AVG(gas_cost_wei::NUMERIC) / 1e18)::NUMERIC, 8) AS avg_gas_cost_native,\n        \n        -- ========================================================================\n        -- GAS COST IN USD (Cross-Chain Comparable)\n        -- ========================================================================\n        -- WHAT: Gas costs converted to USD using native token price at fill time\n        -- WHY:  Native token costs aren't comparable across chains (0.001 ETH \u2260 0.001 MATIC).\n        --       USD conversion enables:\n        --       - Cross-chain gas cost comparison\n        --       - Total relayer operational cost analysis\n        --       - Fee vs gas cost ratio calculations\n        -- USE:  Relayer profitability analysis, corridor cost benchmarking.\n        -- ========================================================================\n        ROUND(SUM(gas_cost_usd)::NUMERIC, 2) AS total_gas_cost_usd,\n        ROUND(AVG(gas_cost_usd)::NUMERIC, 4) AS avg_gas_cost_usd\n        \n    FROM base_data\n    GROUP BY \n        deposit_minute,\n        origin_chain_id,\n        destination_chain_id,\n        route_id,\n        deposit_token\n),\n\n-- ============================================================================\n-- COMPUTED INSIGHTS CTE\n-- ============================================================================\n-- PURPOSE: Transform numeric metrics into categorical labels for easy\n--          Superset filtering, alerting, and executive reporting.\n-- ============================================================================\nwith_insights AS (\n    SELECT\n        *,\n        \n        -- ========================================================================\n        -- PRICING TIER (Categorical Competitive Position)\n        -- ========================================================================\n        -- WHAT: Classifies route as OVERPRICED / HIGH / COMPETITIVE / AGGRESSIVE / VERY_LOW\n        -- WHY:  Enables quick identification of routes where Across may be\n        --       losing users to competitors (OVERPRICED) or leaving money on\n        --       the table (VERY_LOW).\n        --\n        -- DATA-DRIVEN THRESHOLDS (based on actual distribution from dataset):\n        --   Distribution: median=0.0135%, p75=0.056%, p95=0.37%, p99=2.15%\n        --\n        --   - OVERPRICED:   > 0.5%    \u2192 True outliers (~5% of data), investigate\n        --   - HIGH:         0.1-0.5%  \u2192 Above p75, higher than typical (~15%)\n        --   - COMPETITIVE:  0.02-0.1% \u2192 Around median, market rate (~30-40%)\n        --   - AGGRESSIVE:   0.005-0.02% \u2192 Below median, undercutting (~20-30%)\n        --   - VERY_LOW:     < 0.005%  \u2192 Near-zero fees, possibly subsidized (~15%)\n        --\n        -- USE:  Superset filter \"Show OVERPRICED routes\", pricing strategy review.\n        -- ========================================================================\n        CASE \n            WHEN effective_fee_pct > 0.5 THEN 'OVERPRICED'\n            WHEN effective_fee_pct > 0.1 THEN 'HIGH'\n            WHEN effective_fee_pct > 0.02 THEN 'COMPETITIVE'\n            WHEN effective_fee_pct > 0.005 THEN 'AGGRESSIVE'\n            ELSE 'VERY_LOW'\n        END AS pricing_tier,\n        \n        -- ========================================================================\n        -- FEE VOLATILITY TIER (Pricing Stability)\n        -- ========================================================================\n        -- WHAT: Classifies fee consistency as HIGH_VOLATILITY / MODERATE / LOW / STABLE\n        -- WHY:  Users prefer predictable fees. High volatility indicates:\n        --       - Dynamic pricing swings (may be correct but confusing)\n        --       - Liquidity issues causing fee spikes\n        --       - Inconsistent relayer behavior\n        --\n        -- DATA-DRIVEN THRESHOLDS (based on actual distribution from dataset):\n        --   Distribution: median=0.057, p75=0.36, p95=1.68, p99=8.28\n        --\n        --   - HIGH_VOLATILITY:     > 1.0   \u2192 True outliers (~10%), investigate\n        --   - MODERATE_VOLATILITY: 0.3-1.0 \u2192 Above p75, notable variation (~15-20%)\n        --   - LOW_VOLATILITY:      0.05-0.3 \u2192 Around median, acceptable (~40-50%)\n        --   - STABLE:              < 0.05  \u2192 Below median, consistent pricing (~25%)\n        --\n        -- USE:  Alert on HIGH_VOLATILITY routes, UX improvement targeting.\n        -- ========================================================================\n        CASE \n            WHEN fee_std_dev > 1.0 THEN 'HIGH_VOLATILITY'\n            WHEN fee_std_dev > 0.3 THEN 'MODERATE_VOLATILITY'\n            WHEN fee_std_dev > 0.05 THEN 'LOW_VOLATILITY'\n            ELSE 'STABLE'\n        END AS fee_volatility_tier,\n        \n        -- ========================================================================\n        -- FEE SPREAD (Range Indicator)\n        -- ========================================================================\n        -- WHAT: max_fee_pct - min_fee_pct (width of fee range)\n        -- WHY:  Complements std_dev with a simpler measure. Large spread means\n        --       some users got great rates while others got terrible rates.\n        --       Example: min=0.1%, max=1.0% \u2192 spread=0.9% (very inconsistent!)\n        -- USE:  Fairness analysis, identify routes with extreme outliers.\n        -- ========================================================================\n        ROUND((max_fee_pct - min_fee_pct)::NUMERIC, 4) AS fee_spread_pct,\n        \n        -- ========================================================================\n        -- GAS COST TIER (Relayer Economics)\n        -- ========================================================================\n        -- WHAT: Classifies corridors by gas cost level\n        -- WHY:  High gas costs affect relayer profitability and may explain:\n        --       - Higher bridge fees on certain routes\n        --       - Fewer relayers willing to fill (leading to slower fills)\n        --       - Corridors that need optimization\n        --\n        -- DATA-DRIVEN THRESHOLDS (based on actual distribution from dataset):\n        --   Distribution: median=0.00001, p75=0.00016, p95=0.067, p99=0.19\n        --\n        --   - VERY_HIGH: > 0.05 native   \u2192 Top ~5%, expensive corridors\n        --   - HIGH:      0.001-0.05      \u2192 Above p75, notable cost (~10-15%)\n        --   - MEDIUM:    0.0001-0.001    \u2192 Around p75, moderate (~15-20%)\n        --   - LOW:       0.00001-0.0001  \u2192 Around median (~30-40%)\n        --   - VERY_LOW:  < 0.00001       \u2192 Below median, very cheap (~25%)\n        --\n        -- USE:  Corridor optimization, relayer incentive analysis.\n        -- ========================================================================\n        CASE \n            WHEN avg_gas_cost_native > 0.05 THEN 'VERY_HIGH'\n            WHEN avg_gas_cost_native > 0.001 THEN 'HIGH'\n            WHEN avg_gas_cost_native > 0.0001 THEN 'MEDIUM'\n            WHEN avg_gas_cost_native > 0.00001 THEN 'LOW'\n            ELSE 'VERY_LOW'\n        END AS gas_cost_tier\n        \n    FROM hourly_fee_metrics\n)\n\nSELECT\n    -- Time dimension\n    wi.deposit_minute,\n    \n    -- Route identifiers with human-readable names\n    wi.origin_chain_id,\n    oc.chain_name AS origin_chain_name,\n    wi.destination_chain_id,\n    dc.chain_name AS destination_chain_name,\n    wi.route_id,\n    oc.chain_name || ' \u2192 ' || dc.chain_name AS route_name,\n    \n    -- Token info\n    wi.deposit_token,\n    tm.token_symbol,\n    CASE \n        WHEN tm.token_symbol LIKE 'USDC%' THEN 'USDC'\n        WHEN tm.token_symbol LIKE 'USDT%' THEN 'USDT'\n        WHEN tm.token_symbol LIKE 'DAI%' THEN 'DAI'\n        WHEN tm.token_symbol LIKE 'WETH%' THEN 'WETH'\n        WHEN tm.token_symbol LIKE 'WBTC%' THEN 'WBTC'\n        ELSE tm.token_symbol\n    END AS base_token_symbol,\n    \n    -- Volume metrics\n    wi.total_fills,\n    wi.total_deposit_volume_usd,\n    wi.total_filled_volume_usd,\n    \n    -- Fee metrics (USD)\n    wi.total_fees_usd,\n    wi.effective_fee_pct,\n    \n    -- Fee distribution\n    wi.avg_fee_pct,\n    wi.median_fee_pct,\n    wi.fee_std_dev,\n    wi.min_fee_pct,\n    wi.max_fee_pct,\n    wi.fee_spread_pct,\n    \n    -- Slippage (for transparency)\n    wi.avg_slippage_pct,\n    wi.median_slippage_pct,\n    \n    -- Computed insights\n    wi.pricing_tier,\n    wi.fee_volatility_tier,\n    \n    -- Participant metrics\n    wi.unique_depositors,\n    wi.unique_relayers,\n    \n    -- Gas cost metrics (relayer economics)\n    wi.avg_gas_price_gwei,\n    wi.median_gas_price_gwei,\n    wi.total_gas_cost_native,\n    wi.avg_gas_cost_native,\n    wi.total_gas_cost_usd,\n    wi.avg_gas_cost_usd,\n    wi.gas_cost_tier\n\nFROM with_insights wi\nLEFT JOIN chain_names oc ON wi.origin_chain_id = oc.chain_id\nLEFT JOIN chain_names dc ON wi.destination_chain_id = dc.chain_id\nLEFT JOIN token_metadata tm ON wi.origin_chain_id = tm.chain_id \n    AND LOWER(wi.deposit_token) = LOWER(tm.token_address)\n\nORDER BY wi.deposit_minute DESC, wi.total_deposit_volume_usd DESC", "relation_name": "\"across_analytics\".\"dbt_marts\".\"mart_bridge_fee_analysis\"", "batch_results": null}], "elapsed_time": 2.268871784210205, "args": {"invocation_command": "dbt run --select marts", "log_format_file": "debug", "vars": {}, "require_batched_execution_for_custom_microbatch_strategy": false, "require_generic_test_arguments_property": true, "skip_nodes_if_on_run_start_fails": false, "log_level": "info", "log_format": "default", "static_parser": true, "require_nested_cumulative_type_params": false, "use_colors_file": true, "exclude": [], "warn_error_options": {"error": [], "warn": [], "silence": []}, "require_all_warnings_handled_by_warn_error": false, "partial_parse_file_diff": true, "strict_mode": false, "require_yaml_configuration_for_mf_time_spines": false, "print": true, "empty": false, "select": ["marts"], "use_colors": true, "require_explicit_package_overrides_for_builtin_materializations": true, "macro_debugging": false, "show_all_deprecations": false, "send_anonymous_usage_stats": true, "state_modified_compare_more_unrendered_values": false, "cache_selected_only": false, "use_fast_test_edges": false, "defer": false, "show_resource_report": false, "printer_width": 80, "favor_state": false, "require_resource_names_without_spaces": true, "validate_macro_args": false, "which": "run", "introspect": true, "upload_to_artifacts_ingest_api": false, "quiet": false, "project_dir": "C:\\Users\\Longin\\Desktop\\Projects\\across_analytics", "state_modified_compare_vars": false, "populate_cache": true, "log_file_max_bytes": 10485760, "write_json": true, "profiles_dir": "C:\\Users\\Longin\\.dbt", "log_level_file": "debug", "version_check": true, "source_freshness_run_project_hooks": true, "indirect_selection": "eager", "partial_parse": true, "log_path": "C:\\Users\\Longin\\Desktop\\Projects\\across_analytics\\logs"}}